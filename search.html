<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Bitemporal Document Insert/Update Demo</title>

    <style>
      body {
        background-color: #f5f5f5;
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        font-size: 12px;
      }

      #dropdown { 
        height: 40px;
        position: relative;
        left: 0px;
        top: 20px;
        display: block;
        padding: 13px 16px;
        width: 266px;
        position: relative;
        cursor: pointer;
        border-left: 4px solid #739cda;
        background: #fff;
        font-size: 1.55em;
        color: #000000;
        font-weight: normal;
        -webkit-box-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        -moz-box-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        box-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        -webkit-transition: all 0.15s linear;
        -moz-transition: all 0.15s linear;
        -ms-transition: all 0.15s linear;
        -o-transition: all 0.15s linear;
        transition: all 0.15s linear;
    }

      #hi {
        font-weight: bold;
      }

      #dropdown:hover { color: #000000; }

      #dropdown.open {
        background: #5a90e0;
        color: #fff;
        border-left-color: #6c6d70;
      }

      #instructSelect {
        position: absolute;
        left: 0px;
        top: -40px;
        font-weight: bold;
        font-size: 1.55em;
      }

      #bulletList {
        position: absolute;
        left: -40px;
        top: 110px;
        font-size: 1.2em;
      }

      button {
        position: absolute;
        left: 0px;
        top: 80px;
        height: 30px;
        width: 80px;
        font-size: 1.2em;
      }

      #links {
        font-size: 1.25em;
      }

      #page {

        position: relative;
        left: 840px;
        top: 100px;

      }

    </style>

  </head>
  <body>
    <h1>MarkLogic Search Page</h1>
    <div id="tooltip" class="hidden">
        <p><span id="value"></span></p>
    </div>
    <div id= "page">
    <p id="instructSelect">Select a Temporal Collection</p>
    <select id="dropdown"></select>
    <ul id="bulletList"></ul>
    <button type="button" id="search">Search</button>
    </div>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script type="text/javascript">

      //possible JSON response from a GET query of Documents (giving you all the collections)
    // var response = JSON.parse('{"temporal-collection-default-list":{"meta":{"uri":"/manage/v2/databases/Documents/temporal/collections", "current-time":"2015-07-02T16:31:21.690237-07:00", "elapsed-time":{"units":"sec", "value":0.030292}}, "list-items":{"list-count":{"units":"quantity", "value":6}, "list-item":[{"uriref":"?collection=okay", "nameref":"okay"}, {"uriref":"?collection=AshleysCollection", "nameref":"AshleysCollection"}, {"uriref":"?collection=anotherCollection", "nameref":"anotherCollection"}, {"uriref":"?collection=HilarysCollection", "nameref":"HilarysCollection"}, {"uriref":"?collection=myTemporal", "nameref":"myTemporal"}, {"uriref":"?collection=secondCollection", "nameref":"secondCollection"}]}, "related-views":{"related-view":[{"view-type":"root", "view-name":"default", "view-uri":"/manage/v2"}]}}}');

      var response = $.ajax(
        {
          url: "/manage/v2/databases/Documents/temporal/collections?format=json",
          success: function(data, textStatus) {
            console.log('got collections: ' + data);
          },
          error: function(jqXHR, textStatus, errorThrown) {
            console.log('problem');
          },
          async: false
        });

      response = JSON.parse( response.responseText );

      //adds names of the collections to the drop down list
      var addToDrop = $("#dropdown");
      //endpoint is the number of collections
      var endpoint = parseInt(response["temporal-collection-default-list"]["list-items"]["list-count"]["value"]);
      //this for loop appends the collection names to the drop down list
      for (var i = 0; i < endpoint; i++)
      {
        addToDrop.append($("<option>").text(response["temporal-collection-default-list"]["list-items"]["list-item"][i]["nameref"])) ;
      }

      //possible JSON response of each individual collection containing the physical and logical documents (ex: 'addr.json') and each document's system and valid start/end times
      //var docs = JSON.parse('{"snippet-format":"snippet", "total":4,"start":1,"page-length":10, "results":[{"index":1,"uri":"addr.json", "date":"2020-01-01T00:00:00Z 2005-01-01T00:00:00Z 2001-01-01T00:00:00Z 9999-12-31T23:59:59Z Fiona"}, {"index":2, "uri": "addr.18302194850282759876.json", "date": "2002-01-01T00:00:00Z 2005-01-01T00:00:00Z 2001-01-01T00:00:00Z 9999-12-31T23:59:59Z finn"}, {"index": 3, "uri": "myTemporal.lsqt", "date": "2002-01-01T00:00:00Z 2005-01-01T00:00:00Z 2001-01-01T02:00:00Z 9999-12-31T23:59:59Z Fiona"}]}');


      //variable name for the bullet tag
      var bullet = $("#bulletList");
      //function when search button is clicked
      $("#search").click(function(){
        $("#bulletList").empty();
        var e = document.getElementById("dropdown");
        var strUser = e.options[e.selectedIndex].value;

        var docs = $.ajax(
        {
          url: "http://localhost:3000/v1/search?collection="+strUser+"&format=json",
          success: function(data, textStatus) {
            console.log('got collections: ' + data);
          },
          error: function(jqXHR, textStatus, errorThrown) {
            console.log('problem');
          },
          async: false
        });

        docs = JSON.parse( docs.responseText );
        console.log(docs);
        console.log("total= " + docs.total);

        var times = ["Sys Start:", "Sys End:", "Valid Start:", "Valid End:"];
        //nested for loop to loop through the different URI's in the JSON file, and add the URI to the bullet list.
        //then under each uri the system start, system end, valid start, valid end times will be displayed
        for (var i=0; i < docs.total; i++)
        {
           var strLink = docs['results'][i]['uri'];
           bullet.append($("<a href = 'index' id = 'links'>").text(strLink));

           var array = docs["results"][i]["matches"][0]["match-text"][0].split(" ");

           for( var j = 0; j < array.length - 1; j++ )
           {  
              var newDate = new Date(array[j]);
              var strDate = newDate.toString().replace( "GMT-0800 (PST)", "");

              var arrayTimes = strDate.split(" ");
              var strHour = parseInt(arrayTimes[ arrayTimes.length - 2 ]) ;

              strDate = convertDate(strHour, strDate);

              bullet.append($("<ul id='hi'>").text(times[j]), $("<ul>").text("- " + strDate));
           }
        }

      });
      
      function convertDate(strHour, strDate)
      {
        var am_pm = "";
        var strTime = strDate;
          if( strHour > 11)
          {
            am_pm = "pm";
            replace = strHour - parseInt(12);
            strTime = strDate.replace( strHour, replace);
          }
          else if( strHour < 12)
          {
            am_pm = "am";
          }
          
          return "" + strTime + am_pm;
      }

    </script>
   </body>
</html>
