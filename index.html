<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Bitemporal Document Insert/Update Demo</title>
      
    <style>
      body {
        background-color: #f5f5f5;
        font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
        font-size: 12px;
      }
    
    #Edit {
      position: relative;
    top: 620px; /*Relative to height of 'bar-chart-large'*/ 
    left: 20px;
    }

      .svg-chart .background {
        shape-rendering: crispEdges;
        stroke: #ccc;
        fill: #fdfdfd;
        stroke-width: 1px;
      }

      .svg-chart .g { fill: #4682B4; }

      .tooltip-txt {
        margin: 0;
        font-family: Helvetica;
        font-size: 25px;
        line-height: 18px;
      }

      .axis-label {
        font-family: Helvetica;
        font-size: 15px;
      }

      .svg-chart .xaxis .tick text {
        transform: rotate(-45deg);
        text-anchor: end !important;
      }

    </style>

  </head>
  <body>
    <p>Change the logical document display to the specified URI of a logical document.</p>
    <p>Don't forget to include the "dot extension" ie .json.</p>
<!--    <!form window.location='/data/inputText'> -->
    <div>
       Enter URI:<br>
       <input type="text" name="collection" value="">
       <br><br>
       <input type="button" id="pick-doc" value="Submit">
    </div> 

    <h1>MarkLogic Bitemporal Visualization Demo</h1>
    <div id="tooltip" class="hidden">
      <p><span id="value"></span></p>
    </div>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script type="text/javascript" src="public/moment.js"></script>
    <script type="text/javascript" src="public/d3.js"></script>
    <script type="text/javascript" src="public/bitemp_graph.js"></script>
    <script type="text/javascript" src="public/bitemp_graph_helper.js"></script>

    <div id="bar-chart-large"></div>
  
    <script type="text/javascript">
      var inputText = $("input[name='collection']").val();
     // console.log("\nInput text is " + inputText);
     // window.alert(inputText);

      /*takes a string of data returns an array of that data*/
      function parseData(data, collection) {
        var split = data.split('--ML_BOUNDARY');
        var items = [];

        for (var i=0; i < split.length; i++) {
          var item = {
            category: null,
            content: null,
            contentLength: null,
            contentType: null,
            format: null,
            uri: null
          };

          var matches = split[i].match(/Content-Type: ([\w\/]+)/);
          if(matches && matches[1]) {
            item.contentType = matches[1];
          }

          var matches2 = split[i].match(/Content-Disposition: ([\w\/]+); filename="([^"]+)"; category=([\w\/]+); format=([\w\/]+)/);
          if(matches2 && matches2[2]) {
            item.uri = matches2[2];
            if(matches2[3])
              item.category = matches2[3];
            if(matches2[4])
              item.format = matches2[4];
          }

          var matches3 = split[i].match(/Content-Length: ([\d]+)/);
          if(matches3 && matches3[1]) {
            item.contentLength = matches3[1];
          }

          var matches4 = split[i].match(/({[^$]*})/);
          if(matches4 && matches4[1]) {
            item.content = JSON.parse(matches4[1]);
          }

          if(item.content !== null)
            if (collection && collection.indexOf('.') !== -1 && item.uri.substring(0, collection.indexOf('.')) === collection.substring(0, collection.indexOf('.'))) {
              items.push(item);
            }
        }

        return items;
      }

      function loadData(collection) {
        var url = '';
        if (collection !== undefined) {
          url += '/' + collection;
        }
        else {
          collection = 'addr.json';
        }
        $.ajax({
          url: 'http://localhost:3000/v1/search?pageLength=1000&format=json&collection='+collection,
          data: {
            format: 'json',
            collection: collection
          },
          type: "POST",
          headers: {
            Accept: 'multipart/mixed'
          },
          success: function ( data ) { 
            var arrData = parseData(data, collection);
            getBarChart({
              data: arrData,
              width: 800,
              height: 600,
              xAxisLabel: 'System',
              yAxisLabel: 'Valid',
              containerId: 'bar-chart-large'
            });
            if(arrData.length === 0 && url !== '') {
              window.alert('Attention!\nNo data found in doc ' + collection); 
            }
          },
          error: function(jqXHR, textStatus, errorThrown) {
            // something went wrong. Take a look in jqXHR and find the status code
            if(textStatus === 'error') {
              window.alert('ERROR!\nThe status code is ' + jqXHR.statusCode() + '. The error thrown is ' + errorThrown);
              return false;
            }
          }
        }); 
      }

      loadData();

      $('#pick-doc').click( function() {
        var uriCollection = $('input[name = collection]').val();
        if(uriCollection === '') {
          window.alert('Please enter a uri.');
        }
        else {
          loadData(uriCollection);
        }
      })
      $("input[name='insert']").click(function(){
        var col = $("input[name='tempcol']").val();
        var uri = $("input[name='uri']").val();
        var vs = $("input[name='validstart']").val();
        var ve = $("input[name='validend']").val();
        var sys = $("input[name='systemtart']").val();
        var d = $("input[name='content']").val();

        $.get(
          "/update?collection"+col+"&uri="+uri+
          "&validstart="+vs+"&validend="+ve+
          "&system="+sys+"&content="+d);
      });
    </script>
    <script type="text/javascript">
      $.get( "/data", function( data ) {
        getBarChart({
          data: data,
          width: 800,
          height: 600,
          xAxisLabel: 'System',
          yAxisLabel: 'Valid',
          containerId: 'bar-chart-large'
        })
      });
      $("input[name='insert']").click(function(){
        var col = $("input[name='tempcol']").val();
        var uri = $("input[name='uri']").val();
        var vs = $("input[name='validstart']").val();
        var ve = $("input[name='validend']").val();
        var sys = $("input[name='systemtart']").val();
        var d = $("input[name='content']").val();

        $.get(
          "/update?collection"+col+"&uri="+uri+
          "&validstart="+vs+"&validend="+ve+
          "&system="+sys+"&content="+d);
      });
    </script>
  <div id="Edit-Button"> </div>
  <button id="Edit" onclick="displaySearchBox()">Edit</button>
  <script> function displaySearchBox() {  
   
  }
  </script>
   </body>
</html>